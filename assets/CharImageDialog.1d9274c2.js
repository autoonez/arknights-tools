import{ae as U,r as O,d as _,_ as $,c as d,w as p,o as l,a as I,a3 as h,a4 as k,a5 as D,U as S,e as L,ag as j,b as M,l as R,ah as C,ai as z,t as T,D as y,ad as N,ab as b,h as G}from"./index.b2224797.js";import{a as V,c as E}from"./VCard.fdd16d9f.js";import{V as x,a as B}from"./VRow.fe75b3c8.js";import{V as H}from"./VBtn.57065297.js";import{t as P}from"./router.170951ca.js";import{g as q}from"./story-service.9a436c65.js";import{H as F}from"./StoryReaderStore.0d5ec752.js";import{V as K}from"./VDialog.8d1dc922.js";const W=U("CharacterSpriteTable",()=>{const e=O();return{characterSpriteTable:e,getCharacterSpriteTable:async()=>{e.value||(e.value=await F.get("/table/characters_sprites_table.json").then(o=>o.data))}}}),J=_({name:"TagDescription",props:{line:Object}});function Q(e,a,o,c,m,s){return l(),d(V,{class:"my-3"},{default:p(()=>[I(E,{style:{"font-size":"1rem","line-height":"1.5rem"}},{default:p(()=>{var t;return[(l(!0),h(S,null,k((t=e.line)==null?void 0:t.params.text,(n,i)=>(l(),h("p",{key:i},D(n),1))),128))]}),_:1})]),_:1})}const X=$(J,[["render",Q]]),Y=_({name:"TagSubtitle",props:{line:Object}});function Z(e,a,o,c,m,s){return l(),d(V,{class:"my-3"},{default:p(()=>[I(E,{class:"text-center",style:{"font-size":"1rem","line-height":"1.5rem"}},{default:p(()=>{var t;return[(l(!0),h(S,null,k((t=e.line)==null?void 0:t.params.text,(n,i)=>(l(),h("p",{key:i},D(n),1))),128))]}),_:1})]),_:1})}const ee=$(Y,[["render",Z]]),ae=_({name:"TagCharacterSpeech",props:{line:Object},emits:["selectCharImage"]});function te(e,a,o,c,m,s){return l(),d(x,{class:"my-3"},{default:p(()=>[I(B,{cols:"12",sm:"2",class:"pb-0 pb-sm-3"},{default:p(()=>{var t,n;return[L("p",{class:j(["font-weight-bold text-grey",[{hasImage:(t=e.line)==null?void 0:t.params.image}]]),onClick:a[0]||(a[0]=i=>{var r;return e.$emit("selectCharImage",(r=e.line)==null?void 0:r.params.image)})},D((n=e.line)==null?void 0:n.params.name),3)]}),_:1}),I(B,{cols:"12",sm:"8",class:"pt-0 pt-sm-3"},{default:p(()=>{var t;return[(l(!0),h(S,null,k((t=e.line)==null?void 0:t.params.text,(n,i)=>(l(),h("p",{key:i,class:j({"mt-1":i>0})},D(n),3))),128))]}),_:1})]),_:1})}const ne=$(ae,[["render",te],["__scopeId","data-v-e10541f6"]]),re=_({name:"TagDecision",props:{line:Object,decision:Number},emits:["selectDecision"],setup(e){return{getVariant:o=>{var s;let c="elevated";return(e.decision||parseInt((s=e.line)==null?void 0:s.params.options[0].value))===parseInt(o)&&(c="outlined"),c}}}});function se(e,a,o,c,m,s){return l(),d(x,{dense:"",class:"my-3"},{default:p(()=>{var t;return[(l(!0),h(S,null,k((t=e.line)==null?void 0:t.params.options,(n,i)=>(l(),d(B,{cols:"12",key:i},{default:p(()=>[I(H,{class:"float-right text-right decision-option",variant:e.getVariant(n.value),onClick:r=>e.$emit("selectDecision",n.value)},{default:p(()=>[M(D(n.text),1)]),_:2},1032,["variant","onClick"])]),_:2},1024))),128))]}),_:1})}const ie=$(re,[["render",se]]),ce=_({name:"TagImage",props:{line:Object},setup(e){return{imageSrc:R(()=>{var c,m,s,t,n;let o="";return(c=e.line)!=null&&c.params.image?(((m=e.line)==null?void 0:m.tag)==="IMAGE"&&(o=`${C}/images/avg/imgs/${(s=e.line)==null?void 0:s.params.image}.webp`),((t=e.line)==null?void 0:t.tag)==="BACKGROUND"&&(o=`${C}/images/avg/bg/${(n=e.line)==null?void 0:n.params.image}.webp`)):o=`${C}/images/avg/bg/bg_black.webp`,o})}}});function le(e,a,o,c,m,s){return l(),d(P,{src:e.imageSrc,class:"my-3"},null,8,["src"])}const oe=$(ce,[["render",le]]),me=_({name:"TagSticker",props:{line:Object}}),ue=["innerHTML"];function ge(e,a,o,c,m,s){return l(),d(V,{class:"my-3"},{default:p(()=>[I(E,{style:{"font-size":"1rem","line-height":"1.5rem"}},{default:p(()=>{var t;return[(l(!0),h(S,null,k((t=e.line)==null?void 0:t.params.text,(n,i)=>(l(),h("p",{key:i},[L("span",{innerHTML:n},null,8,ue)]))),128))]}),_:1})]),_:1})}const de=$(me,[["render",ge]]),pe=_({name:"RenderBlock",emits:["selectCharImage"],props:{renderBlock:{type:[Object],default:[]}},setup(e){const a=z({}),o=({id:m,value:s})=>{a[m]=parseInt(s)},c=R(()=>{let m=[],s;for(let t=0;t<e.renderBlock.length;t++){let n=e.renderBlock[t];switch(n.tag){case"DECISION":{s=a[t]||parseInt(n.params.options[0].value),m.push(t);break}case"PREDICATE":{let i=n.params.references;if(s){if(!i.includes(s.toString())){for(let r=t+1;r<e.renderBlock.length;r++)if(e.renderBlock[r].tag==="PREDICATE"){t=r-1;break}else if(r===e.renderBlock.length-1){t=r;break}}}else s=null;break}default:{m.push(t);break}}}return m});return{decisionByLineIndex:a,selectDecision:o,lineIndexsToShow:c}},components:{TagDescription:X,TagSubtitle:ee,TagCharacterSpeech:ne,TagDecision:ie,TagImage:oe,TagSticker:de}});function fe(e,a,o,c,m,s){const t=b("TagDescription"),n=b("TagSticker"),i=b("TagSubtitle"),r=b("TagCharacterSpeech"),u=b("TagDecision"),v=b("TagImage");return l(!0),h(S,null,k(e.renderBlock,(g,f)=>(l(),h(S,{key:f},[g.tag==="DESCRIPTION"?T((l(),d(t,{key:0,line:g},null,8,["line"])),[[y,e.lineIndexsToShow.includes(f)]]):N("",!0),g.tag==="STICKER"?T((l(),d(n,{key:1,line:g},null,8,["line"])),[[y,e.lineIndexsToShow.includes(f)]]):g.tag==="SUBTITLE"?T((l(),d(i,{key:2,line:g},null,8,["line"])),[[y,e.lineIndexsToShow.includes(f)]]):g.tag==="DIALOG"?T((l(),d(r,{key:3,line:g,onSelectCharImage:a[0]||(a[0]=w=>{e.$emit("selectCharImage",w)})},null,8,["line"])),[[y,e.lineIndexsToShow.includes(f)]]):g.tag==="DECISION"?T((l(),d(u,{key:4,line:g,decision:e.decisionByLineIndex[f],onSelectDecision:w=>{e.selectDecision({id:f,value:w})}},null,8,["line","decision","onSelectDecision"])),[[y,e.lineIndexsToShow.includes(f)]]):["IMAGE","BACKGROUND"].includes(g.tag)?T((l(),d(v,{key:5,line:g},null,8,["line"])),[[y,e.lineIndexsToShow.includes(f)]]):N("",!0)],64))),128)}const De=$(pe,[["render",fe]]);var he={format:"image/png",quality:.92,width:void 0,height:void 0,Canvas:void 0,crossOrigin:void 0},_e=function(e,a){return e===void 0&&(e=[]),a===void 0&&(a={}),new Promise(function(o){a=Object.assign({},he,a);var c=a.Canvas?new a.Canvas:window.document.createElement("canvas"),m=a.Image||window.Image,s=e.map(function(n){return new Promise(function(i,r){n.constructor.name!=="Object"&&(n={src:n});var u=new m;u.crossOrigin=a.crossOrigin,u.onerror=function(){return r(new Error("Couldn't load image"))},u.onload=function(){return i(Object.assign({},n,{img:u}))},u.src=n.src})}),t=c.getContext("2d");o(Promise.all(s).then(function(n){var i=function(r){return a[r]||Math.max.apply(Math,n.map(function(u){return u.img[r]}))};return c.width=i("width"),c.height=i("height"),n.forEach(function(r){return t.globalAlpha=r.opacity?r.opacity:1,t.drawImage(r.img,r.x||0,r.y||0)}),a.Canvas&&a.format==="image/jpeg"?new Promise(function(r,u){c.toDataURL(a.format,{quality:a.quality,progressive:!1},function(v,g){if(v){u(v);return}r(g)})}):c.toDataURL(a.format,a.quality)}))})};const $e=_({name:"CharImageDialog",emits:["closeDialog"],props:{charImage:String},setup(e){const{characterSpriteTable:a}=W(),o=O({}),c=O(!1),m=O("");return G(()=>e.charImage,async()=>{if(e.charImage){if(o.value[e.charImage])c.value=!0,m.value=o.value[e.charImage];else if(a){let s="",t,{name:n,num:i,group:r}=q(e.charImage);n=n.toLowerCase(),i=i.trim(),r=r.trim();let u=a[n];if(u[r].sprites[i].isWholeBody===0){let v=Object.keys(u[r].sprites)[Object.keys(u[r].sprites).length-1];if(v!==i){let g=u[r].sprites[v].sprite,f=`${C}/images/avg/characters/${n}/${g}`,w=u[r].sprites[i].sprite,A=`${C}/images/avg/characters/${n}/${w}`;s=await _e([{src:f,x:0,y:0},{src:A,x:u[r].facePos.x,y:u[r].facePos.y}],{crossOrigin:"anonymous",format:"image/webp"})}}else t=u[r].sprites[i].sprite,s=`${C}/images/avg/characters/${n}/${t}`;o.value[e.charImage]=s,m.value=s,c.value=!0}}else c.value=!1}),{show:c,imageSrc:m}}});function ve(e,a,o,c,m,s){return l(),d(K,{modelValue:e.show,"onUpdate:modelValue":a[0]||(a[0]=t=>e.show=t),class:"custom-overlay",onClick:a[1]||(a[1]=t=>e.$emit("closeDialog"))},{default:p(()=>[I(P,{src:e.imageSrc},null,8,["src"])]),_:1},8,["modelValue"])}const Oe=$($e,[["render",ve]]);export{Oe as C,De as R,W as u};
