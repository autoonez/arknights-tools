import{V as z,y as w,d as v,_ as b,c as d,w as I,o as f,b as _,s as C,u as k,v as O,F as S,a as H,X as L,e as K,g as U,Y as $,Z as X,R as D,$ as x,O as Y,r as y,a0 as B,a1 as N,a2 as A,a3 as V,a4 as R,a5 as J,G as W}from"./index.abfb314c.js";import{V as j,b as G}from"./VCard.a6c9d27f.js";import{V as M,a as E}from"./VRow.1c7812c4.js";import{V as Z}from"./VBtn.d9438d7e.js";import{e as F}from"./router.2bd6cf50.js";import{H as Q}from"./StoryReaderStore.62d1f282.js";import{V as ee}from"./VDialog.2bde1a24.js";const ae=z("CharacterSpriteTable",()=>{const t=w();return{characterSpriteTable:t,getCharacterSpriteTable:async()=>{t.value||(t.value=await Q.get("/table/characters_sprites_table.json").then(o=>o.data))}}}),te=v({name:"TagDescription",props:{line:Object}});function se(t,s,o,e,c,i){return f(),d(j,{class:"my-3"},{default:I(()=>[_(G,{style:{"font-size":"1rem","line-height":"1.5rem"}},{default:I(()=>{var l;return[(f(!0),C(S,null,k((l=t.line)==null?void 0:l.params.text,(r,n)=>(f(),C("p",{key:n},O(r),1))),128))]}),_:1})]),_:1})}const re=b(te,[["render",se]]),ne=v({name:"TagSubtitle",props:{line:Object}});function ie(t,s,o,e,c,i){return f(),d(j,{class:"my-3"},{default:I(()=>[_(G,{class:"text-center",style:{"font-size":"1rem","line-height":"1.5rem"}},{default:I(()=>{var l;return[(f(!0),C(S,null,k((l=t.line)==null?void 0:l.params.text,(r,n)=>(f(),C("p",{key:n},O(r),1))),128))]}),_:1})]),_:1})}const le=b(ne,[["render",ie]]),oe=v({name:"TagCharacterSpeech",props:{line:Object},emits:["selectCharImage"]});function ce(t,s,o,e,c,i){return f(),d(M,{class:"my-3"},{default:I(()=>[_(E,{cols:"12",sm:"2",class:"pb-0 pb-sm-3"},{default:I(()=>{var l,r;return[H("p",{class:L(["font-weight-bold text-grey",[{hasImage:(l=t.line)==null?void 0:l.params.image}]]),onClick:s[0]||(s[0]=n=>{var a;return t.$emit("selectCharImage",(a=t.line)==null?void 0:a.params.image)})},O((r=t.line)==null?void 0:r.params.name),3)]}),_:1}),_(E,{cols:"12",sm:"8",class:"pt-0 pt-sm-3"},{default:I(()=>{var l;return[(f(!0),C(S,null,k((l=t.line)==null?void 0:l.params.text,(r,n)=>(f(),C("p",{key:n,class:L({"mt-1":n>0})},O(r),3))),128))]}),_:1})]),_:1})}const ue=b(oe,[["render",ce],["__scopeId","data-v-e10541f6"]]),me=v({name:"TagDecision",props:{line:Object,decision:Number},emits:["selectDecision"],setup(t){return{getVariant:o=>{var i;let e="elevated";return(t.decision||parseInt((i=t.line)==null?void 0:i.params.options[0].value))===parseInt(o)&&(e="outlined"),e}}}});function pe(t,s,o,e,c,i){return f(),d(M,{dense:"",class:"my-3"},{default:I(()=>{var l;return[(f(!0),C(S,null,k((l=t.line)==null?void 0:l.params.options,(r,n)=>(f(),d(E,{cols:"12",key:n},{default:I(()=>[_(Z,{class:"float-right text-right decision-option",variant:t.getVariant(r.value),onClick:a=>t.$emit("selectDecision",r.value)},{default:I(()=>[K(O(r.text),1)]),_:2},1032,["variant","onClick"])]),_:2},1024))),128))]}),_:1})}const ge=b(me,[["render",pe]]),fe=v({name:"TagImage",props:{line:Object},setup(t){return{imageSrc:U(()=>{var e,c,i,l,r;let o="";return(e=t.line)!=null&&e.params.image?(((c=t.line)==null?void 0:c.tag)==="IMAGE"&&(o=`${$}/images/avg/imgs/${(i=t.line)==null?void 0:i.params.image}.webp`),((l=t.line)==null?void 0:l.tag)==="BACKGROUND"&&(o=`${$}/images/avg/bg/${(r=t.line)==null?void 0:r.params.image}.webp`)):o=`${$}/images/avg/bg/bg_black.webp`,o})}}});function he(t,s,o,e,c,i){return f(),d(F,{src:t.imageSrc,class:"my-3"},null,8,["src"])}const de=b(fe,[["render",he]]),Ie=v({name:"RenderBlock",emits:["selectCharImage"],props:{renderBlock:{type:[Object],default:[]}},setup(t){const s=X({}),o=({id:c,value:i})=>{s[c]=parseInt(i)},e=U(()=>{let c=[],i;for(let l=0;l<t.renderBlock.length;l++){let r=t.renderBlock[l];switch(r.tag){case"DECISION":{i=s[l]||parseInt(r.params.options[0].value),c.push(l);break}case"PREDICATE":{let n=r.params.references;if(i){if(!n.includes(i.toString())){for(let a=l+1;a<t.renderBlock.length;a++)if(t.renderBlock[a].tag==="PREDICATE"){l=a-1;break}else if(a===t.renderBlock.length-1){l=a;break}}}else i=null;break}default:{c.push(l);break}}}return c});return{decisionByLineIndex:s,selectDecision:o,lineIndexsToShow:e}},components:{TagDescription:re,TagSubtitle:le,TagCharacterSpeech:ue,TagDecision:ge,TagImage:de}});function Ce(t,s,o,e,c,i){const l=y("TagDescription"),r=y("TagSubtitle"),n=y("TagCharacterSpeech"),a=y("TagDecision"),u=y("TagImage");return f(!0),C(S,null,k(t.renderBlock,(m,p)=>(f(),C(S,{key:p},[m.tag==="DESCRIPTION"?D((f(),d(l,{key:0,line:m},null,8,["line"])),[[x,t.lineIndexsToShow.includes(p)]]):m.tag==="SUBTITLE"?D((f(),d(r,{key:1,line:m},null,8,["line"])),[[x,t.lineIndexsToShow.includes(p)]]):m.tag==="DIALOG"?D((f(),d(n,{key:2,line:m,onSelectCharImage:s[0]||(s[0]=g=>{t.$emit("selectCharImage",g)})},null,8,["line"])),[[x,t.lineIndexsToShow.includes(p)]]):m.tag==="DECISION"?D((f(),d(a,{key:3,line:m,decision:t.decisionByLineIndex[p],onSelectDecision:g=>{t.selectDecision({id:p,value:g})}},null,8,["line","decision","onSelectDecision"])),[[x,t.lineIndexsToShow.includes(p)]]):["IMAGE","BACKGROUND"].includes(m.tag)?D((f(),d(u,{key:4,line:m},null,8,["line"])),[[x,t.lineIndexsToShow.includes(p)]]):Y("",!0)],64))),128)}const Ee=b(Ie,[["render",Ce]]);var Te={format:"image/png",quality:.92,width:void 0,height:void 0,Canvas:void 0,crossOrigin:void 0},ve=function(t,s){return t===void 0&&(t=[]),s===void 0&&(s={}),new Promise(function(o){s=Object.assign({},Te,s);var e=s.Canvas?new s.Canvas:window.document.createElement("canvas"),c=s.Image||window.Image,i=t.map(function(r){return new Promise(function(n,a){r.constructor.name!=="Object"&&(r={src:r});var u=new c;u.crossOrigin=s.crossOrigin,u.onerror=function(){return a(new Error("Couldn't load image"))},u.onload=function(){return n(Object.assign({},r,{img:u}))},u.src=r.src})}),l=e.getContext("2d");o(Promise.all(i).then(function(r){var n=function(a){return s[a]||Math.max.apply(Math,r.map(function(u){return u.img[a]}))};return e.width=n("width"),e.height=n("height"),r.forEach(function(a){return l.globalAlpha=a.opacity?a.opacity:1,l.drawImage(a.img,a.x||0,a.y||0)}),s.Canvas&&s.format==="image/jpeg"?new Promise(function(a,u){e.toDataURL(s.format,{quality:s.quality,progressive:!1},function(m,p){if(m){u(m);return}a(p)})}):e.toDataURL(s.format,s.quality)}))})};const Le=t=>{var c,i,l;let s={lines:[],tagCount:{},otherLines:[]},o=t.split(`
`),e=r=>{r in s.tagCount||(s.tagCount[r]=0),s.tagCount[r]+=1};for(const r of o)if(r.match(B)){let n=B.exec(r);if(n!=null&&n.groups){let{tag:a,params:u,other:m}=n.groups;a=a.toUpperCase();let p={},g;for(;(g=N.exec(u))!==null;)if(g.groups){const{name:h,value:T}=g.groups;p[h]=T.replace(/"/g,"")}m&&(p.other=m),s.lines.push({tag:a,params:p}),e(a)}}else if(r.match(A)){let n=A.exec(r);if(n!=null&&n.groups){let{name:a,params:u,text:m}=n.groups,p={},g;if(u)for(;(g=N.exec((c=n==null?void 0:n.groups)==null?void 0:c.params))!==null;){let h=(i=g.groups)==null?void 0:i.name,T=((l=g.groups)==null?void 0:l.value)||"";h&&(p[h]=T.replace(/"/g,""))}s.lines.push({tag:"DIALOG",params:{...p,name:a,text:m}}),e("DIALOG")}}else if(r.match(V)){let n=V.exec(r);if(n!=null&&n.groups){let{tag:a,value:u}=n.groups;a=a.toUpperCase(),s.lines.push({tag:a,params:{[a]:u}}),e(a)}}else if(r.match(R)){let n=R.exec(r);if(n!=null&&n.groups){let{tag:a}=n.groups;a=a.toUpperCase(),s.lines.push({tag:a,params:{}}),e(a)}}else if(r.length>0&&r.indexOf("//")!==0){let n="DESCRIPTION";s.lines.push({tag:n,params:{text:r}}),e(n)}else s.otherLines.push(r);return s},P=/\[OPTION (?<value>.*)\]/g,Be=t=>{var o;let s={lines:[],tagCount:{},otherLines:[]};try{const e=t.find(c=>c[0]==="[LAYOUT]");if(e){const c=e.indexOf("[NAME]"),i=e.indexOf("[TEXT]");if(c&&i){for(let l=0;l<t.length;l++){const r=t[l];let n=r[0]||"";n=n.replace(/[\[\]]/g,"");const a=r[c],u=r[i];if(J.includes(n))s.lines.push({tag:n,params:{name:a,text:u}}),n in s.tagCount?s.tagCount[n]=s.tagCount[n]+1:s.tagCount[n]=1;else if(n==="DECISION"){let m=[],p=[];for(let g=l+1;g<t.length;g++){const h=t[g];if(h[0]==="[END_DECISION]"){s.lines.push({tag:"DECISION",params:{options:m.join(";"),values:p.join(";")}}),"DECISION"in s.tagCount?s.tagCount.DECISION=s.tagCount.DECISION+1:s.tagCount.DECISION=1,l=g;break}if(h[0].match(P)){const T=P.exec(h[0]);if(T){const q=(o=T.groups)==null?void 0:o.value;p.push(q),m.push(h[i])}}}}}return{result:s}}else return{error:"[NAME] or [TEXT] not found"}}else return{error:"[LAYOUT] not found"}}catch(e){return{error:e.message}}},Ne=({original:t,target:s})=>{let o=[],e={},c={};for(const i of s)i.tag in e||(e[i.tag]=[],c[i.tag]=0),e[i.tag].push(i);for(const i of t)if(i.tag in e)if(c[i.tag]<e[i.tag].length&&Object.keys(i.params).length>0){const l=e[i.tag][c[i.tag]],r=i;i.params.name&&l.params.name&&(r.params.name=l.params.name),i.params.text&&l.params.text&&(r.params.text=l.params.text),i.params.options&&l.params.options&&(r.params.options=l.params.options),o.push(r),c[i.tag]+=1}else o.push(i);else o.push(i);return o},be=t=>{let s="1",o="1",e="";return t.split("#").length>1?([e,s]=t.split("#"),[s,o]=s.split("$")):t.split("$").length>1?[e,o]=t.split("$"):e=t.split("#")[0],{name:e,num:s,group:o||"1"}},Ae=async t=>{var l,r;let s=[],o=[],e,c,i="";for(let n=0;n<t.length;n++){let a=t[n];switch(a.tag){case"DESCRIPTION":{e?e.tag==="DESCRIPTION"?e.params.text.push(a.params.text):(o.push(e),e={tag:"DESCRIPTION",params:{text:[a.params.text]}}):e={tag:"DESCRIPTION",params:{text:[a.params.text]}};break}case"SUBTITLE":{a.params.text&&(e?e.tag==="SUBTITLE"?e.params.text.push(a.params.text):(o.push(e),e={tag:"SUBTITLE",params:{text:[a.params.text]}}):e={tag:"SUBTITLE",params:{text:[a.params.text]}});break}case"DIALOG":{if(!a.params.text)break;let u={...a.params,text:[a.params.text],image:i};e?e.tag==="DIALOG"&&((r=(l=e.params)==null?void 0:l.name)==null?void 0:r.localeCompare(a.params.name,void 0,{sensitivity:"base"}))===0?e.params.text.push(a.params.text):(o.push(e),e={tag:"DIALOG",params:u}):e={tag:"DIALOG",params:u};break}case"MULTILINE":{let u={tag:"DIALOG",params:{...a.params,text:[a.params.other],image:i}};e&&o.push(e),e=u;break}case"DECISION":{e&&o.push(e);let u=a.params.options.split(";"),m=a.params.values.split(";"),p=!1;if(c){for(let g of m)if(c.options.includes(g)){p=!0;break}}p&&(s.push(o),o=[],e=null),(!c||p)&&(c={options:m}),e={...a,params:{options:u.map((g,h)=>({text:g,value:m[h]}))}};break}case"PREDICATE":{e&&o.push(e);let u=a.params.references.split(";");e={...a,params:{references:u}};break}case"IMAGE":{e&&o.push(e),e=a;break}case"BACKGROUND":{e&&o.push(e),e=a;break}case"CHARACTER":{if(a.params.focus)switch(parseInt(a.params.focus)){case 1:{i=a.params.name;break}case 2:{i=a.params.name2;break}default:{i="";break}}else i=a.params.name;break}}}return e&&o[o.length-1]!==e&&o.push(e),s[s.length-1]!==o&&s.push(o),s},$e=v({name:"CharImageDialog",emits:["closeDialog"],props:{charImage:String},setup(t){const{characterSpriteTable:s}=ae(),o=w({}),e=w(!1),c=w("");return W(()=>t.charImage,async()=>{if(t.charImage){if(o.value[t.charImage])e.value=!0,c.value=o.value[t.charImage];else if(s){let i="",l,{name:r,num:n,group:a}=be(t.charImage);r=r.toLowerCase(),n=n.trim(),a=a.trim();let u=s[r];if(u[a].sprites[n].isWholeBody===0){let m=Object.keys(u[a].sprites)[Object.keys(u[a].sprites).length-1];if(m!==n){let p=u[a].sprites[m].sprite,g=`${$}/images/avg/characters/${r}/${p}`,h=u[a].sprites[n].sprite,T=`${$}/images/avg/characters/${r}/${h}`;i=await ve([{src:g,x:0,y:0},{src:T,x:u[a].facePos.x,y:u[a].facePos.y}],{crossOrigin:"anonymous",format:"image/webp"})}}else l=u[a].sprites[n].sprite,i=`${$}/images/avg/characters/${r}/${l}`;o.value[t.charImage]=i,c.value=i,e.value=!0}}else e.value=!1}),{show:e,imageSrc:c}}});function _e(t,s,o,e,c,i){return f(),d(ee,{modelValue:t.show,"onUpdate:modelValue":s[0]||(s[0]=l=>t.show=l),class:"custom-overlay",onClick:s[1]||(s[1]=l=>t.$emit("closeDialog"))},{default:I(()=>[_(F,{src:t.imageSrc},null,8,["src"])]),_:1},8,["modelValue"])}const Ve=b($e,[["render",_e]]);export{Ve as C,Ee as R,Ae as a,Be as b,Ne as r,Le as s,ae as u};
