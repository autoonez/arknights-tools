import{d as T,l as h,_ as D,c as m,w as d,o as c,a as n,a3 as k,a4 as E,b as B,a5 as R,U as C,r as g,aG as q,ab as $,h as W,aO as X,ad as V}from"./index.039e7fc9.js";import{u as I,H as L,a as x}from"./StoryReaderStore.925af092.js";import{s as j,d as P,e as ee,r as te}from"./story-service.e922bb9c.js";import{u as oe}from"./StoryTableStore.9269012b.js";import{R as se,C as re}from"./CharImageDialog.1388a271.js";import{V as z}from"./VDialog.1bd2028f.js";import{V as A,a as U,c as H,b as ae}from"./VList.8450a8a2.js";import{a as Q,b as le}from"./VCard.923c5cea.js";import{V as J}from"./VBottomNavigation.5ce44f17.js";import{V as _}from"./VBtn.885e87c3.js";import{V as ne}from"./VContainer.d7668c2d.js";import"./VRow.12cc1312.js";/* empty css              */import"./router.d4a02ace.js";import"./forwardRefs.9af43674.js";import"./index.59fbb740.js";const ie=T({name:"StorySelectorDialog",emits:["selectStory"],setup(){const e=I();return{storySet:h(()=>e.storySet),getStoryTitle:o=>e.getStoryTitle(o)}}});function ue(e,t,r,o,i,y){return c(),m(z,null,{default:d(()=>[n(Q,null,{default:d(()=>[n(A,null,{default:d(()=>{var s;return[(c(!0),k(C,null,E((s=e.storySet)==null?void 0:s.story,(a,S,l)=>(c(),m(U,{key:l,onClick:u=>e.$emit("selectStory",S)},{default:d(()=>[n(H,null,{default:d(()=>[B(R(e.getStoryTitle(S.toString())),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]}),_:1})]),_:1})]),_:1})}const ce=D(ie,[["render",ue]]),de=T({name:"StoryRenderBottomNav",setup(){const e=q(),t=g(!1),r=I(),o=h(()=>r.storySet),i=h(()=>r.story),y=h(()=>{let l="";return o.value&&i.value&&(i.value.code?l=`${i.value.code}: ${i.value.name[r.language]}`:l=`${i.value.name[r.language]}`),l});return{dialog:t,storyTitle:y,selectPreviousStory:()=>{var l;if(o.value){const u=Object.values((l=o.value)==null?void 0:l.story).find(p=>i.value?p.sort===i.value.sort-1:!1);u&&e.push({name:"render-story",query:{storyFile:u.file,storySetId:o.value.id,type:"original"}})}},selectNextStory:()=>{var l;if(o.value){const u=Object.values((l=o.value)==null?void 0:l.story).find(p=>i.value?p.sort===i.value.sort+1:!1);u&&e.push({name:"render-story",query:{storyFile:u.file,storySetId:o.value.id,type:"original"}})}},selectStory:l=>{if(t.value=!1,o.value){const u=o.value.story[l];e.push({name:"render-story",query:{storyFile:u.file,storySetId:o.value.id,type:"original"}})}}}},components:{StorySelectorDialog:ce}});function ye(e,t,r,o,i,y){const s=$("StorySelectorDialog");return c(),k(C,null,[n(s,{modelValue:e.dialog,"onUpdate:modelValue":t[0]||(t[0]=a=>e.dialog=a),onSelectStory:e.selectStory},null,8,["modelValue","onSelectStory"]),n(J,{density:"compact"},{default:d(()=>[n(_,{icon:"mdi-chevron-left",onClick:e.selectPreviousStory},null,8,["onClick"]),n(_,{variant:"text",class:"story-title-btn",onClick:t[1]||(t[1]=a=>e.dialog=!0)},{default:d(()=>[B(R(e.storyTitle),1)]),_:1}),n(_,{icon:"mdi-chevron-right",onClick:e.selectNextStory},null,8,["onClick"])]),_:1})],64)}const Se=D(de,[["render",ye],["__scopeId","data-v-73ec32d9"]]),pe=T({name:"StorySelectorDialogGoogleSheets",emits:["selectStory"],setup(){const e=I(),t=h(()=>e.spreadsheet),r=h(()=>{var o;return((o=t.value)==null?void 0:o.sheets)||[]});return{spreadsheet:t,sheets:r}}});function me(e,t,r,o,i,y){return c(),m(z,null,{default:d(()=>[n(Q,null,{default:d(()=>{var s;return[n(_,{variant:"text",href:(s=e.spreadsheet)==null?void 0:s.url},{default:d(()=>{var a;return[B(R(((a=e.spreadsheet)==null?void 0:a.title)||""),1)]}),_:1},8,["href"]),n(ae),n(A,null,{default:d(()=>[(c(!0),k(C,null,E(e.sheets,(a,S)=>(c(),m(U,{key:S,onClick:l=>e.$emit("selectStory",S)},{default:d(()=>[n(H,null,{default:d(()=>[B(R(a),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]}),_:1})]),_:1})}const fe=D(pe,[["render",me]]),he=T({name:"StoryRenderBottomNavGoogleSheets",setup(){const e=g(!1),t=I(),r=h(()=>t.spreadsheet?t.spreadsheet.sheets[t.spreadsheet.currentSheet]:"");return{dialog:e,storyTitle:r,selectPreviousStory:()=>{var s;if(t.spreadsheet){const a=(s=t.spreadsheet)==null?void 0:s.sheets[t.spreadsheet.currentSheet-1];t.spreadsheet.currentSheet>0&&a&&t.setSpreadsheetCurrentSheet(t.spreadsheet.currentSheet-1)}},selectNextStory:()=>{var s;t.spreadsheet&&((s=t.spreadsheet)==null?void 0:s.sheets[t.spreadsheet.currentSheet+1])&&t.setSpreadsheetCurrentSheet(t.spreadsheet.currentSheet+1)},selectStory:s=>{e.value=!1,t.setSpreadsheetCurrentSheet(s)}}},components:{StorySelectorDialogGoogleSheets:fe}});function ve(e,t,r,o,i,y){const s=$("StorySelectorDialogGoogleSheets");return c(),k(C,null,[n(s,{modelValue:e.dialog,"onUpdate:modelValue":t[0]||(t[0]=a=>e.dialog=a),onSelectStory:e.selectStory},null,8,["modelValue","onSelectStory"]),n(J,{density:"compact"},{default:d(()=>[n(_,{icon:"mdi-chevron-left",onClick:e.selectPreviousStory},null,8,["onClick"]),n(_,{variant:"text",class:"story-title-btn",onClick:t[1]||(t[1]=a=>e.dialog=!0)},{default:d(()=>[B(R(e.storyTitle),1)]),_:1}),n(_,{icon:"mdi-chevron-right",onClick:e.selectNextStory},null,8,["onClick"])]),_:1})],64)}const ge=D(he,[["render",ve],["__scopeId","data-v-88119425"]]),_e=T({name:"StoryRender",props:["storyFile","storySetId","type"],components:{RenderBlock:se,CharImageDialog:re,StoryRenderBottomNav:Se,StoryRenderBottomNavGoogleSheets:ge},setup(e){const t=q(),r=I(),{storyTable:o,storyList:i}=oe(),y=g(!1),s=g(!1),a=g([]),S=g(""),l=h(()=>r.language),u=h(()=>r.storySet),p=g([]);return W(()=>{var v;return[e.storyFile,e.storySetId,e.type,l.value,(v=r.spreadsheet)==null?void 0:v.currentSheet]},async()=>{var v;try{if(y.value=!0,e.type==="original"){e.storySetId&&r.setStorySet(o==null?void 0:o.story[e.storySetId]),e.storyFile||(u.value?t.push({name:X[u.value.type].routeName||"select-story-type"}):t.push({name:"select-story-type"})),u.value&&r.setStory(Object.values(u.value.story).find(O=>O.file===e.storyFile));const w=(await L.get(`/story/${l.value}/${e.storyFile}.txt`)).data,b=j(w);p.value=await P(b.lines),s.value=!0,window.scrollTo(0,0)}else if(e.type==="spreadsheet")if(r.spreadsheet){const{id:f,sheets:w,currentSheet:b}=r.spreadsheet,F=(v=(await L.get(`https://sheets.googleapis.com/v4/spreadsheets/${f}/values/'${w[b]}'`,{params:{key:"AIzaSyDu129ufi2q02ZHJhoLYsO_0ew6nh9kQAQ"}})).data)==null?void 0:v.values,N=ee(F);if(!N.error)if(F[0][0]==="[FILE]"){const Y=F[0][1],Z=i.find(G=>G.includes(Y)),K=(await L.get(`/story/zh_CN/${Z}`)).data,M=j(K);if(N.result){const G=te({original:M.lines,target:N.result.lines});p.value=await P(G),s.value=!0,window.scrollTo(0,0)}}else N.result&&(p.value=await P(N.result.lines),s.value=!0,window.scrollTo(0,0))}else t.push({name:"google-sheets"});else t.push({name:"select-story-type"})}catch(f){f instanceof x.exports.AxiosError&&l.value!=="zh_CN"&&(f==null?void 0:f.code)==="ERR_BAD_REQUEST"?r.setLanguage("zh_CN"):a.value.push(f)}finally{y.value=!1}},{immediate:!0}),{loading:y,ready:s,charImage:S,errors:a,storySet:u,renderBlocks:p}}});function $e(e,t,r,o,i,y){const s=$("RenderBlock"),a=$("StoryRenderBottomNav"),S=$("StoryRenderBottomNavGoogleSheets"),l=$("CharImageDialog");return c(),k(C,null,[e.loading?(c(),m(le,{key:0,indeterminate:""})):V("",!0),e.ready?(c(),m(ne,{key:1},{default:d(()=>[(c(!0),k(C,null,E(e.renderBlocks,(u,p)=>(c(),m(s,{key:p,"render-block":u,onSelectCharImage:t[0]||(t[0]=v=>{e.charImage=v})},null,8,["render-block"]))),128))]),_:1})):V("",!0),e.type==="original"?(c(),m(a,{key:2})):V("",!0),e.type==="spreadsheet"?(c(),m(S,{key:3})):V("",!0),e.ready?(c(),m(l,{key:4,"char-image":e.charImage,onCloseDialog:t[1]||(t[1]=u=>e.charImage="")},null,8,["char-image"])):V("",!0)],64)}const je=D(_e,[["render",$e]]);export{je as default};
