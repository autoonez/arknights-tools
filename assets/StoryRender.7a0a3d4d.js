import{aB as w,aC as N,aD as V,aE as H,aF as O,Q as E,d as _,h as y,_ as D,c as b,w as S,o as C,f as h,i as A,r as U,b as F,t as G,F as $,j as R,aA as j,e as Q,m as W,aG as Y,n as k,v as J,x as L,H as T,E as X,aH as Z,L as x}from"./index.9343c9cb.js";import{u as P,a as ee,H as te,b as ae}from"./StoryReaderStore.7eb69d57.js";import{a as se,m as re,e as oe,u as le,f as ne,g as ie,V as B,R as ue,C as ce}from"./CharImageDialog.92cc772b.js";import{V as me}from"./VDialog.e1527ab2.js";import{V as ge,a as fe,c as de}from"./VList.63621a54.js";import{V as pe,a as ye}from"./VCard.8884702a.js";import{m as ve,j as he,a as Ce,b as Se,d as Re,u as be,r as Ee,e as Ie,f as ke,h as Te}from"./router.753e3c43.js";import{m as Ae,u as $e}from"./tag.5404cb9c.js";import{V as xe}from"./VContainer.305eee74.js";import"./VRow.5c0385be.js";/* empty css              */var Be={format:"image/png",quality:.92,width:void 0,height:void 0,Canvas:void 0,crossOrigin:void 0},_e=function(t,s){return t===void 0&&(t=[]),s===void 0&&(s={}),new Promise(function(c){s=Object.assign({},Be,s);var l=s.Canvas?new s.Canvas:window.document.createElement("canvas"),i=s.Image||window.Image,r=t.map(function(o){return new Promise(function(n,a){o.constructor.name!=="Object"&&(o={src:o});var e=new i;e.crossOrigin=s.crossOrigin,e.onerror=function(){return a(new Error("Couldn't load image"))},e.onload=function(){return n(Object.assign({},o,{img:e}))},e.src=o.src})}),f=l.getContext("2d");c(Promise.all(r).then(function(o){var n=function(a){return s[a]||Math.max.apply(Math,o.map(function(e){return e.img[a]}))};return l.width=n("width"),l.height=n("height"),o.forEach(function(a){return f.globalAlpha=a.opacity?a.opacity:1,f.drawImage(a.img,a.x||0,a.y||0)}),s.Canvas&&s.format==="image/jpeg"?new Promise(function(a,e){l.toDataURL(s.format,{quality:s.quality,progressive:!1},function(u,m){if(u){e(u);return}a(m)})}):l.toDataURL(s.format,s.quality)}))})};const De=t=>{var i,r,f;let s={lines:[],tagCount:{},otherLines:[]},c=t.split(`
`),l=o=>{o in s.tagCount||(s.tagCount[o]=0),s.tagCount[o]+=1};for(const o of c)if(o.match(w)){let n=w.exec(o);if(n!=null&&n.groups){let{tag:a,params:e,other:u}=n.groups;a=a.toUpperCase();let m={},g;for(;(g=N.exec(e))!==null;)if(g.groups){const{name:p,value:d}=g.groups;m[p]=d.replace(/"/g,"")}u&&(m.other=u),s.lines.push({tag:a,params:m}),l(a)}}else if(o.match(V)){let n=V.exec(o);if(n!=null&&n.groups){let{name:a,params:e,text:u}=n.groups,m={},g;if(e)for(;(g=N.exec((i=n==null?void 0:n.groups)==null?void 0:i.params))!==null;){let p=(r=g.groups)==null?void 0:r.name,d=((f=g.groups)==null?void 0:f.value)||"";p&&(m[p]=d.replace(/"/g,""))}s.lines.push({tag:"CHARACTER_SPEECH",params:{...m,name:a,text:u}}),l("CHARACTER_SPEECH")}}else if(o.match(H)){let n=H.exec(o);if(n!=null&&n.groups){let{tag:a,value:e}=n.groups;a=a.toUpperCase(),s.lines.push({tag:a,params:{[a]:e}}),l(a)}}else if(o.match(O)){let n=O.exec(o);if(n!=null&&n.groups){let{tag:a}=n.groups;a=a.toUpperCase(),s.lines.push({tag:a,params:{}}),l(a)}}else if(o.length>0&&o.indexOf("//")!==0){let n="DESCRIPTION";s.lines.push({tag:n,params:{text:o}}),l(n)}else s.otherLines.push(o);return s},Pe=t=>{let s="1",c="1",l="";return t.split("#").length>1?([l,s]=t.split("#"),[s,c]=s.split("$")):t.split("$").length>1?[l,c]=t.split("$"):l=t.split("#")[0],{name:l,num:s,group:c||"1"}},we=async t=>{var n;const{characterSpriteTable:s}=se();let c=[],l={IMAGE:{},BACKGROUND:{},CHARACTER:{}},i=[],r,f,o="";for(let a=0;a<t.lines.length;a++){let e=t.lines[a];switch(e.tag){case"DESCRIPTION":{r?r.tag==="DESCRIPTION"?r.params.text.push(e.params.text):(i.push(r),r={tag:"DESCRIPTION",params:{text:[e.params.text]}}):r={tag:"DESCRIPTION",params:{text:[e.params.text]}};break}case"SUBTITLE":{e.params.text&&(r?r.tag==="SUBTITLE"?r.params.text.push(e.params.text):(i.push(r),r={tag:"SUBTITLE",params:{text:[e.params.text]}}):r={tag:"SUBTITLE",params:{text:[e.params.text]}});break}case"CHARACTER_SPEECH":{let u={...e.params,text:[e.params.text],image:o};r?r.tag==="CHARACTER_SPEECH"&&((n=r.params)==null?void 0:n.name.localeCompare(e.params.name,void 0,{sensitivity:"base"}))===0?r.params.text.push(e.params.text):(i.push(r),r={tag:"CHARACTER_SPEECH",params:u}):r={tag:"CHARACTER_SPEECH",params:u};break}case"MULTILINE":{let u={tag:"CHARACTER_SPEECH",params:{...e.params,text:[e.params.other],image:o}};r&&i.push(r),r=u;break}case"DECISION":{r&&i.push(r);let u=e.params.options.split(";"),m=e.params.values.split(";"),g=!1;if(f){for(let p of m)if(f.options.includes(p)){g=!0;break}}g&&(c.push(i),i=[],r=null),(!f||g)&&(f={options:m}),r={...e,params:{options:u.map((p,d)=>({text:p,value:m[d]}))}};break}case"PREDICATE":{r&&i.push(r);let u=e.params.references.split(";");r={...e,params:{references:u}};break}case"IMAGE":{r&&i.push(r),r=e;break}case"BACKGROUND":{r&&i.push(r),r=e;break}case"CHARACTER":{if(e.params.focus)switch(parseInt(e.params.focus)){case 1:{o=e.params.name;break}case 2:{o=e.params.name2;break}default:{o="";break}}else o=e.params.name;break}}if(["IMAGE","BACKGROUND","CHARACTER"].includes(e.tag)){if(["IMAGE","BACKGROUND"].includes(e.tag)){if(e.params.image&&!(e.params.image in l[e.tag])){let u=new Image,m="";e.tag==="IMAGE"&&(m=`${E}/images/avg/imgs/${e.params.image}.png`),e.tag==="BACKGROUND"&&(m=`${E}/images/avg/bg/${e.params.image}.png`),u.src=m,l[e.tag][e.params.image]=m}}else if(e.tag==="CHARACTER"&&s&&!(o in l.CHARACTER)&&o){let u="",m,{name:g,num:p,group:d}=Pe(o);g=g.toLocaleLowerCase(),p=p.trim(),d=d.trim();let v=s[g];if(v[d].sprites[p].isWholeBody===0){let I=Object.keys(v[d].sprites)[Object.keys(v[d].sprites).length-1];if(I!==p){let M=v[d].sprites[I].sprite,q=`${E}/images/avg/characters/${g}/${M}`,z=v[d].sprites[p].sprite,K=`${E}/images/avg/characters/${g}/${z}`;u=await _e([{src:q,x:0,y:0},{src:K,x:v[d].facePos.x,y:v[d].facePos.y}],{crossOrigin:"anonymous",format:"image/webp"})}}else m=v[d].sprites[p].sprite,u=`${E}/images/avg/characters/${g}/${m}`;l.CHARACTER[o]=u}}}return r&&i[i.length-1]!==r&&i.push(r),c[c.length-1]!==i&&c.push(i),{renderBlocks:c,imagesUrl:l}},Ne=_({name:"StorySelectorDialog",emits:["selectStory"],setup(){const t=P();return{storySet:y(()=>t.storySet),getStoryTitle:l=>t.getStoryTitle(l)}}});function Ve(t,s,c,l,i,r){return C(),b(me,null,{default:S(()=>[h(pe,null,{default:S(()=>[h(ge,null,{default:S(()=>{var f;return[(C(!0),A($,null,U((f=t.storySet)==null?void 0:f.story,(o,n,a)=>(C(),b(fe,{key:a,onClick:e=>t.$emit("selectStory",n)},{default:S(()=>[h(de,null,{default:S(()=>[F(G(t.getStoryTitle(n.toString())),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]}),_:1})]),_:1})]),_:1})}const He=D(Ne,[["render",Ve]]),Oe=_({name:"StoryRenderBottomNav",setup(){const t=j(),s=R(!1),c=P(),l=y(()=>c.storySet),i=y(()=>c.story),r=y(()=>{let a="";return l.value&&i.value&&(i.value.code?a=`${i.value.code}: ${i.value.name[c.language]}`:a=`${i.value.name[c.language]}`),a});return{dialog:s,storyTitle:r,selectPreviousStory:()=>{var a;if(l.value){const e=Object.values((a=l.value)==null?void 0:a.story).find(u=>i.value?u.sort===i.value.sort-1:!1);e&&t.push({name:"render-story",query:{storyFile:e.file,storySetId:l.value.id}})}},selectNextStory:()=>{var a;if(l.value){const e=Object.values((a=l.value)==null?void 0:a.story).find(u=>i.value?u.sort===i.value.sort+1:!1);e&&t.push({name:"render-story",query:{storyFile:e.file,storySetId:l.value.id}})}},selectStory:a=>{if(s.value=!1,l.value){const e=l.value.story[a];t.push({name:"render-story",query:{storyFile:e.file,storySetId:l.value.id}})}}}},components:{StorySelectorDialog:He}});const Le=Q({name:"VBottomNavigation",props:{bgColor:String,color:String,grow:Boolean,mode:{type:String,validator:t=>!t||["horizontal","shift"].includes(t)},height:{type:[Number,String],default:56},...ve(),...he(),...Ce(),...Se(),...re({name:"bottom-navigation"}),...Ae({tag:"header"}),...oe({modelValue:!0,selectedClass:"v-btn--selected"}),...W()},emits:{"update:modelValue":t=>!0},setup(t,s){let{slots:c}=s;const{themeClasses:l}=Y(),{borderClasses:i}=Re(t),{backgroundColorClasses:r,backgroundColorStyles:f}=be(k(t,"bgColor")),{densityClasses:o}=Ee(t),{elevationClasses:n}=Ie(t),{roundedClasses:a}=ke(t),e=y(()=>Number(t.height)-(t.density==="comfortable"?8:0)-(t.density==="compact"?16:0)),u=Te(t,"modelValue",t.modelValue),{layoutItemStyles:m}=le({id:t.name,order:y(()=>parseInt(t.order,10)),position:y(()=>"bottom"),layoutSize:y(()=>u.value?e.value:0),elementSize:e,active:u,absolute:k(t,"absolute")});return ne(t,ie),J({VBtn:{color:k(t,"color"),density:k(t,"density"),stacked:y(()=>t.mode!=="horizontal"),variant:"text"}},{scoped:!0}),$e(()=>h(t.tag,{class:["v-bottom-navigation",{"v-bottom-navigation--active":u.value,"v-bottom-navigation--grow":t.grow,"v-bottom-navigation--shift":t.mode==="shift"},l.value,r.value,i.value,o.value,n.value,a.value],style:[f.value,m.value,{height:L(e.value),transform:`translateY(${L(u.value?0:100,"%")})`}]},{default:()=>[c.default&&h("div",{class:"v-bottom-navigation__content"},[c.default()])]})),{}}});function Ue(t,s,c,l,i,r){const f=T("StorySelectorDialog");return C(),A($,null,[h(f,{modelValue:t.dialog,"onUpdate:modelValue":s[0]||(s[0]=o=>t.dialog=o),onSelectStory:t.selectStory},null,8,["modelValue","onSelectStory"]),h(Le,{density:"compact"},{default:S(()=>[h(B,{icon:"mdi-chevron-left",onClick:t.selectPreviousStory},null,8,["onClick"]),h(B,{variant:"text",class:"story-title-btn",onClick:s[1]||(s[1]=o=>t.dialog=!0)},{default:S(()=>[F(G(t.storyTitle),1)]),_:1}),h(B,{icon:"mdi-chevron-right",onClick:t.selectNextStory},null,8,["onClick"])]),_:1})],64)}const Fe=D(Oe,[["render",Ue],["__scopeId","data-v-f1ff141a"]]),Ge=_({name:"StoryRender",props:["storyFile","storySetId"],components:{RenderBlock:ue,CharImageDialog:ce,StoryRenderBottomNav:Fe},setup(t){const s=j(),c=P(),{storyTable:l}=ee(),i=R(!1),r=R(!1),f=R([]),o=R(""),n=y(()=>m.value?m.value.CHARACTER[o.value]:""),a=y(()=>c.language),e=y(()=>c.storySet),u=R([]),m=R();return X(()=>[t.storyFile,t.storySetId,a.value],async()=>{try{i.value=!0,t.storySetId&&c.setStorySet(l==null?void 0:l.story[t.storySetId]),t.storyFile||(e.value?s.push({name:Z[e.value.type].routeName||"select-story-type"}):s.push({name:"select-story-type"})),e.value&&c.setStory(Object.values(e.value.story).find(I=>I.file===t.storyFile));const p=(await te.get(`/story/${a.value}/${t.storyFile}.txt`)).data,d=De(p),v=await we(d);u.value=v.renderBlocks,m.value=v.imagesUrl,r.value=!0,window.scrollTo(0,0)}catch(g){g instanceof ae.exports.AxiosError&&a.value!=="zh_CN"&&(g==null?void 0:g.code)==="ERR_BAD_REQUEST"?c.setLanguage("zh_CN"):f.value.push(g)}finally{i.value=!1}},{immediate:!0}),{loading:i,ready:r,charImage:o,charImageSrc:n,errors:f,storySet:e,renderBlocks:u,imagesUrlDict:m}}});function je(t,s,c,l,i,r){const f=T("RenderBlock"),o=T("StoryRenderBottomNav"),n=T("CharImageDialog");return C(),A($,null,[t.loading?(C(),b(ye,{key:0,indeterminate:""})):x("",!0),t.ready?(C(),b(xe,{key:1},{default:S(()=>[(C(!0),A($,null,U(t.renderBlocks,(a,e)=>(C(),b(f,{key:e,"render-block":a,onSelectCharImage:s[0]||(s[0]=u=>{t.charImage=u})},null,8,["render-block"]))),128))]),_:1})):x("",!0),h(o),t.ready?(C(),b(n,{key:2,"image-src":t.charImageSrc,onCloseDialog:s[1]||(s[1]=a=>t.charImage="")},null,8,["image-src"])):x("",!0)],64)}const tt=D(Ge,[["render",je]]);export{tt as default};
