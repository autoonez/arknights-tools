var me=Object.defineProperty,he=Object.defineProperties;var ge=Object.getOwnPropertyDescriptors;var G=Object.getOwnPropertySymbols;var ye=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable;var z=(e,t,r)=>t in e?me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,E=(e,t)=>{for(var r in t||(t={}))ye.call(t,r)&&z(e,r,t[r]);if(G)for(var r of G(t))_e.call(t,r)&&z(e,r,t[r]);return e},b=(e,t)=>he(e,ge(t));import{_ as T,o as l,c as h,w as c,a as _,r as k,V as w,b as m,d as C,t as x,e as $,F as f,f as Y,g as O,n as B,h as L,i as v,j as R,k as fe,l as pe,m as M,p as Se,q as ve,s as Ce,u as Te,v as Ee,x as Ie,y as xe,z as Re,A as ke,B as q,C as be,D as Le,E as De,G as Oe,H as Ae,I as A,J as Be,K as I,L as we,M as Ye,N as P,O as K,P as X,Q as N,R as se,S as ae}from"./index.e7a919b0.js";import{V as J,a as U,b as ne,c as ie,d as V,e as le,f as F}from"./VProgressLinear.4d00d357.js";const H=[{id:"MAIN_STORY",name:"Main Theme"},{id:"ACTIVITY_STORY",name:"Public Affairs"},{id:"MINI_STORY",name:"Special Operation"},{id:"CHARACTER_STORY",name:"Operator Records"}],Q=[{id:"zh_CN",name:"China"},{id:"en_US",name:"Global"},{id:"ja_JP",name:"Japan"},{id:"ko_KR",name:"Korea"},{id:"zh_TW",name:"Taiwan"}],$e={emits:["SELECT_TYPE"],data(){return{storyTypeList:H}}};function Pe(e,t,r,o,s,a){return l(),h(Y,null,{default:c(()=>[(l(!0),_(f,null,k(s.storyTypeList,(n,u)=>(l(),h(w,{key:u,onClick:i=>this.$emit("SELECT_TYPE",n.id)},{default:c(()=>[m($,null,{default:c(()=>[C(x(n.name),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})}var Ne=T($e,[["render",Pe]]);const Ve={props:["items","server","type","stage"],emits:["SELECT_HOME","SELECT_TYPE","SELECT_STORY_ID"],methods:{getStoryName(e){return`${e.code?`${e.code}: `:""}${e.name[this.server]}`}}},He=C("mdi-home");function Me(e,t,r,o,s,a){return l(),_(f,null,[m(L,{variant:"text",class:B({"d-none":r.type==="preview","d-none d-sm-inline-flex":r.type!=="preview"}),onClick:t[0]||(t[0]=n=>this.$emit("SELECT_HOME"))},{default:c(()=>[m(O,null,{default:c(()=>[He]),_:1})]),_:1},8,["class"]),r.items.type?(l(),h(L,{key:0,variant:"text",class:B({"d-none d-sm-inline-flex":r.type==="preview"||r.type!=="preview"&&r.stage!=="SELECT_STORY_ID"}),onClick:t[1]||(t[1]=n=>this.$emit("SELECT_TYPE",r.items.type.id))},{default:c(()=>[C(x(r.items.type.name),1)]),_:1},8,["class"])):v("",!0),r.items.episode?(l(),h(L,{key:1,variant:"text",class:B({"d-none d-sm-inline-flex":r.type==="preview"||r.type!=="preview"&&r.stage!=="SELECT_STORY_INDEX"}),onClick:t[2]||(t[2]=n=>this.$emit("SELECT_STORY_ID",r.items.episode.id))},{default:c(()=>[C(x(r.items.episode.name[r.server]),1)]),_:1},8,["class"])):v("",!0),r.items.story?(l(),h(L,{key:2,variant:"text",class:B({"d-none d-sm-inline-flex":r.type!=="preview"})},{default:c(()=>[C(x(a.getStoryName(r.items.story)),1)]),_:1},8,["class"])):v("",!0)],64)}var Ue=T(Ve,[["render",Me]]);const Fe={props:["storyByChapter","server"],emits:["SELECT_STORY_ID"],methods:{getEpisode(e){return`Episode ${e.split("_")[1]}`},getImageSrc(e){return`${R}/images/storyEntryPic/main/zone_page_${e}.png`}}};function je(e,t,r,o,s,a){return l(!0),_(f,null,k(r.storyByChapter,(n,u)=>(l(),_(f,{key:u},[r.server in n.name?(l(),h(Y,{key:0},{default:c(()=>[m(fe,null,{default:c(()=>[C(x(n.name[r.server]),1)]),_:2},1024),(l(!0),_(f,null,k(n.story,(i,d)=>(l(),h(w,{key:d,"prepend-avatar":a.getImageSrc(i.id),onClick:y=>this.$emit("SELECT_STORY_ID",i.id)},{default:c(()=>[m(M,null,{default:c(()=>[m($,null,{default:c(()=>[C(x(a.getEpisode(i.id)),1)]),_:2},1024),m(pe,null,{default:c(()=>[C(x(i.name[r.server]),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["prepend-avatar","onClick"]))),128))]),_:2},1024)):v("",!0)],64))),128)}var Ge=T(Fe,[["render",je]]);const ze={props:["storyList","server"],emits:["SELECT_STORY_ID"],methods:{getImageSrc(e){return`${R}/images/storyEntryPic/activity/${e}.png`}}};function qe(e,t,r,o,s,a){return l(),h(Y,null,{default:c(()=>[(l(!0),_(f,null,k(r.storyList,(n,u)=>(l(),_(f,{key:u},[r.server in n.name?(l(),h(w,{key:0,"prepend-avatar":a.getImageSrc(n.entryPic),onClick:i=>this.$emit("SELECT_STORY_ID",n.id)},{default:c(()=>[m(M,null,{default:c(()=>[m($,null,{default:c(()=>[C(x(n.name[r.server]),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["prepend-avatar","onClick"])):v("",!0)],64))),128))]),_:1})}var Ke=T(ze,[["render",qe]]);const Xe={props:["storyList","server"],emits:["SELECT_STORY_INDEX"],methods:{getStoryName(e){return`${e.code?`${e.code}: `:""}${e.name[this.server]}`}}};function Je(e,t,r,o,s,a){return l(),h(Y,null,{default:c(()=>[(l(!0),_(f,null,k(r.storyList,(n,u)=>(l(),_(f,{key:u},[r.server in n.name?(l(),h(w,{key:0,onClick:i=>this.$emit("SELECT_STORY_INDEX",n.sort)},{default:c(()=>[m(M,null,{default:c(()=>[m($,null,{default:c(()=>[C(x(a.getStoryName(n)),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])):v("",!0)],64))),128))]),_:1})}var Qe=T(Xe,[["render",Je]]);const We={props:["storyList","server"],emits:["SELECT_STORY_ID"],methods:{getImageSrc(e){return`${R}/images/avatar/${e}.png`}}};function Ze(e,t,r,o,s,a){return l(),h(Y,null,{default:c(()=>[(l(!0),_(f,null,k(r.storyList,(n,u)=>(l(),_(f,{key:u},[r.server in n.name?(l(),h(w,{key:0,"prepend-avatar":a.getImageSrc(n.character.id),onClick:i=>this.$emit("SELECT_STORY_ID",n.id),title:n.character.name[r.server],subtitle:n.name[r.server]},null,8,["prepend-avatar","onClick","title","subtitle"])):v("",!0)],64))),128))]),_:1})}var et=T(We,[["render",Ze]]);const tt=Se({name:"VFooter",props:E(E(E(E(E(E({app:Boolean,color:String,height:{type:[Number,String],default:"auto"}},ve()),Ce()),Te()),Ee()),Ie({tag:"footer"})),xe()),setup(e,t){let{slots:r}=t;const{themeClasses:o}=Re(e),{backgroundColorClasses:s,backgroundColorStyles:a}=ke(q(e,"color")),{borderClasses:n}=be(e),{elevationClasses:u}=Le(e),{roundedClasses:i}=De(e),d=Oe(32),{resizeRef:y}=Ae(S=>{!S.length||(d.value=S[0].target.clientHeight)}),p=A(()=>e.height==="auto"?d.value:parseInt(e.height,10)),{layoutItemStyles:g}=Be({id:e.name,order:A(()=>parseInt(e.order,10)),position:A(()=>"bottom"),layoutSize:p,elementSize:A(()=>e.height==="auto"?void 0:p.value),active:A(()=>e.app),absolute:q(e,"absolute")});return()=>m(e.tag,{ref:y,class:["v-footer",o.value,s.value,n.value,u.value,i.value],style:[a,e.app?g.value:void 0]},r)}}),rt={props:["storyTable"],emits:["selectFile"],data(){return{dialog:!1,ready:!1,stage:"SELECT_TYPE",story:{type:"",id:"",index:1},server:"en_US",serverList:Q}},created(){this.$watch(()=>[this.$route.query.storyType,this.$route.query.storyId,this.$route.query.storyIndex,this.$route.query.server],()=>{this.getUrlQuery()},{immediate:!0})},computed:{stageComponent(){let e="TYPE";return this.stage==="SELECT_STORY_ID"&&this.story.type==="MAIN_STORY"&&(e="MAIN"),this.stage==="SELECT_STORY_ID"&&["ACTIVITY_STORY","MINI_STORY"].includes(this.story.type)&&(e="ACTIVITY"),this.stage==="SELECT_STORY_ID"&&this.story.type==="CHARACTER_STORY"&&(e="CHARACTER"),this.stage==="SELECT_STORY_INDEX"&&(e="INDEX"),e}},methods:{getUrlQuery(){let e=this.$route.query,t=!1,r="en_US",o;if(e.server&&Q.find(s=>s.id===e.server)&&(this.server=e.server),r=e.server,e.storyType&&H.find(s=>s.id===e.storyType)){let s=e.storyType;if(this.story.type=s,e.storyId&&e.storyId in this.storyTable.story[s]){let a=e.storyId,n=this.storyTable.story[s][a];if(r in n.name){this.story.id=a;let u;e.storyIndex&&(u=n.story.find(i=>i.sort===parseInt(e.storyIndex)))&&(this.story.index=u.sort,o=u.file,t=!0)}}}t?this.$emit("selectFile",{file:o,server:this.server}):this.dialog=!0},getMainStoryByChapter(){let e=Object.entries(this.storyTable.story.MAIN_STORY).reduce((t,[r,o])=>{if(!(o.chapter in t)){let s=this.storyTable.data.chapter[o.chapter];t[o.chapter]={id:o.chapter,name:s.name,story:[]}}return t[o.chapter].story.push(b(E({},o),{id:r})),t},{});return Object.values(e)},getActivityStoryList(){return Object.entries(this.storyTable.story[this.story.type]).map(([e,t])=>b(E({},t),{id:e}))},getCharacterStoryList(){return Object.entries(this.storyTable.story.CHARACTER_STORY).map(([e,t])=>{let r=this.storyTable.data.character[t.character];return b(E({},t),{id:e,character:{id:t.character,name:r.name}})})},getStoryList(){return this.storyTable.story[this.story.type][this.story.id].story},getBreadcrumbItems(){let e,t,r;return e=H.find(o=>o.id===this.story.type),e&&(t=this.storyTable.story[this.story.type][this.story.id]),t&&(r=t.story.find(o=>o.sort===this.story.index)),{type:e,episode:t?b(E({},t),{id:this.story.id}):void 0,story:r?b(E({},r),{index:this.story.index}):void 0}},selectHome(){this.ready=!1,this.stage="SELECT_TYPE",this.story={}},selectType(e){this.ready=!1,this.stage="SELECT_STORY_ID",this.story={type:e}},selectStoryId(e){this.ready=!1,this.stage="SELECT_STORY_INDEX",this.story={type:this.story.type,id:e}},selectStoryIndex(e){this.story={type:this.story.type,id:this.story.id,index:e},this.ready=!0},select(){this.dialog=!1,this.$router.push({path:"/story-reader",query:{storyType:this.story.type,storyId:this.story.id,storyIndex:this.story.index,server:this.server}})},goBack(){this.ready=!1,this.stage==="SELECT_STORY_INDEX"?this.stage="SELECT_STORY_ID":this.stage="SELECT_TYPE"}},components:{StorySelectorType:Ne,StorySelectorBreadcrumb:Ue,StorySelectorMain:Ge,StorySelectorActivity:Ke,StorySelectorIndex:Qe,StorySelectorCharacter:et}},st=C("mdi-close"),at=C("mdi-earth"),nt=["value"],it=C("Select"),lt=C("mdi-close"),ot=C("mdi-earth"),ct=["value"],ut=C("mdi-chevron-left"),dt=C("Select");function mt(e,t,r,o,s,a){const n=I("StorySelectorBreadcrumb"),u=I("StorySelectorType"),i=I("StorySelectorMain"),d=I("StorySelectorActivity"),y=I("StorySelectorCharacter"),p=I("StorySelectorIndex");return l(),h(ne,{modelValue:s.dialog,"onUpdate:modelValue":t[7]||(t[7]=g=>s.dialog=g),scrim:!1,transition:"dialog-bottom-transition",fullscreen:"",scrollable:"",class:"dialog"},{activator:c(({props:g})=>[m(Ye,we({density:"compact"},g),{default:c(()=>[m(n,{items:a.getBreadcrumbItems(),server:s.server,type:"preview"},null,8,["items","server"])]),_:2},1040)]),default:c(()=>[m(U,null,{default:c(()=>[m(P,{density:"compact",class:"d-none d-sm-flex"},{default:c(()=>[m(L,{icon:"",dark:"",onClick:t[0]||(t[0]=g=>s.dialog=!1)},{default:c(()=>[m(O,null,{default:c(()=>[st]),_:1})]),_:1}),m(n,{items:a.getBreadcrumbItems(),server:s.server,stage:s.stage,onSELECT_HOME:a.selectHome,onSELECT_TYPE:a.selectType},null,8,["items","server","stage","onSELECT_HOME","onSELECT_TYPE"]),m(J),m(O,null,{default:c(()=>[at]),_:1}),K(N("select",{"onUpdate:modelValue":t[1]||(t[1]=g=>s.server=g)},[(l(!0),_(f,null,k(s.serverList,(g,S)=>(l(),_("option",{key:S,value:g.id},x(g.name),9,nt))),128))],512),[[X,s.server]]),m(L,{disabled:!s.ready,variant:"outlined",text:"",onClick:t[2]||(t[2]=g=>a.select())},{default:c(()=>[it]),_:1},8,["disabled"])]),_:1}),m(P,{density:"compact",class:"d-flex d-sm-none"},{default:c(()=>[m(L,{icon:"",dark:"",onClick:t[3]||(t[3]=g=>s.dialog=!1)},{default:c(()=>[m(O,null,{default:c(()=>[lt]),_:1})]),_:1}),m(n,{items:a.getBreadcrumbItems(),server:s.server,stage:s.stage,onSELECT_HOME:a.selectHome,onSELECT_TYPE:a.selectType},null,8,["items","server","stage","onSELECT_HOME","onSELECT_TYPE"])]),_:1}),m(P,{density:"compact",class:"d-flex d-sm-none"},{default:c(()=>[m(O,null,{default:c(()=>[ot]),_:1}),K(N("select",{"onUpdate:modelValue":t[4]||(t[4]=g=>s.server=g)},[(l(!0),_(f,null,k(s.serverList,(g,S)=>(l(),_("option",{key:S,value:g.id},x(g.name),9,ct))),128))],512),[[X,s.server]])]),_:1}),m(se,{class:"dialog-container overflow-auto my-3"},{default:c(()=>[a.stageComponent==="TYPE"?(l(),h(u,{key:0,onSELECT_TYPE:a.selectType},null,8,["onSELECT_TYPE"])):v("",!0),a.stageComponent==="MAIN"?(l(),h(i,{key:1,storyByChapter:a.getMainStoryByChapter(),server:s.server,onSELECT_STORY_ID:a.selectStoryId},null,8,["storyByChapter","server","onSELECT_STORY_ID"])):v("",!0),a.stageComponent==="ACTIVITY"?(l(),h(d,{key:2,storyList:a.getActivityStoryList(),server:s.server,onSELECT_STORY_ID:a.selectStoryId},null,8,["storyList","server","onSELECT_STORY_ID"])):v("",!0),a.stageComponent==="CHARACTER"?(l(),h(y,{key:3,storyList:a.getCharacterStoryList(),server:s.server,onSELECT_STORY_ID:a.selectStoryId},null,8,["storyList","server","onSELECT_STORY_ID"])):v("",!0),a.stageComponent==="INDEX"?(l(),h(p,{key:4,storyList:a.getStoryList(),server:s.server,onSELECT_STORY_INDEX:a.selectStoryIndex},null,8,["storyList","server","onSELECT_STORY_INDEX"])):v("",!0)]),_:1}),m(tt,{bottom:"",fixed:"",border:"",height:"48px",class:"footer d-flex d-sm-none",width:"100%"},{default:c(()=>[m(L,{variant:"text",onClick:t[5]||(t[5]=g=>a.goBack())},{default:c(()=>[m(O,null,{default:c(()=>[ut]),_:1})]),_:1}),m(J),m(L,{disabled:!s.ready,variant:"outlined",text:"",onClick:t[6]||(t[6]=g=>a.select())},{default:c(()=>[dt]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}var ht=T(rt,[["render",mt]]);const W=/\[(?<tag>.+?)\((?<params>.*)\)\]\s*(?<other>.*)/g,Z=/\[(?<tag>.*)=(?<value>.*)\]/g,ee=/\[(?<tag>.*)\]/,te=/(?<name>\w*?)\s*=\s*(?<value>".*?"|[^",)\]\s]*)/g,re=/\[[Nn][Aa][Mm][Ee]="(?<name>.*)"(?<params>.*)\]\s*(?<text>.*)/g,gt=e=>{let t={lines:[],tagCount:{},otherLines:[]},r=e.split(`
`),o=s=>{s in t.tagCount||(t.tagCount[s]=0),t.tagCount[s]+=1};for(const s of r)if(s.match(W)){let{tag:a,params:n,other:u}=W.exec(s).groups;a=a.toUpperCase();let i={},d;for(;(d=te.exec(n))!==null;){let{name:y,value:p}=d.groups;i[y]=p.replace(/"/g,"")}u&&(i.other=u),t.lines.push({tag:a,params:i}),o(a)}else if(s.match(re)){let{name:a,params:n,text:u}=re.exec(s).groups,i={},d;for(;(d=te.exec(n))!==null;){let{name:y,value:p}=d.groups;i[y]=p.replace(/"/g,"")}t.lines.push({tag:"CHARACTER_SPEECH",params:b(E({},i),{name:a,text:u})}),o("CHARACTER_SPEECH")}else if(s.match(Z)){let{tag:a,value:n}=Z.exec(s).groups;a=a.toUpperCase(),t.lines.push({tag:a,params:{[a]:n}}),o(a)}else if(s.match(ee)){let{tag:a}=ee.exec(s).groups;a=a.toUpperCase(),t.lines.push({tag:a,params:{}}),o(a)}else if(s.length>0&&s.indexOf("//"!==0)){let a="DESCRIPTION";t.lines.push({tag:a,params:{text:s}}),o(a)}else t.otherLines.push(s);return t},yt={props:["line"]};function _t(e,t,r,o,s,a){return l(),h(U,{class:"my-3"},{default:c(()=>[m(ie,{style:{"font-size":"1rem","line-height":"1.5rem"}},{default:c(()=>[(l(!0),_(f,null,k(r.line.params.text,(n,u)=>(l(),_("p",{key:u},x(n),1))),128))]),_:1})]),_:1})}var ft=T(yt,[["render",_t]]);const pt={props:["line"],emits:["selectCharImage"]};function St(e,t,r,o,s,a){return l(),h(le,{class:"my-3"},{default:c(()=>[m(V,{cols:"12",sm:"2",class:"pb-0 pb-sm-3"},{default:c(()=>[N("p",{class:B(["font-weight-bold text-grey",[{hasImage:r.line.params.image}]]),onClick:t[0]||(t[0]=n=>e.$emit("selectCharImage",r.line.params.image))},x(r.line.params.name),3)]),_:1}),m(V,{cols:"12",sm:"8",class:"pt-0 pt-sm-3"},{default:c(()=>[(l(!0),_(f,null,k(r.line.params.text,(n,u)=>(l(),_("p",{key:u,class:B({"mt-1":u>0})},x(n),3))),128))]),_:1})]),_:1})}var vt=T(pt,[["render",St]]);const Ct={props:["line","decision"],emits:["selectDecision"],methods:{getVariant(e){let t="contained";return(this.decision[this.line.params.id]||this.line.params.options[0].value)===e&&(t="outlined"),t},selectDecision(e){this.$emit("selectDecision",{id:this.line.params.id,value:e})}}};function Tt(e,t,r,o,s,a){return l(),h(le,{dense:"",class:"my-3"},{default:c(()=>[(l(!0),_(f,null,k(r.line.params.options,(n,u)=>(l(),h(V,{cols:"12",key:u},{default:c(()=>[m(L,{class:"float-right text-right",variant:a.getVariant(n.value),onClick:i=>a.selectDecision(n.value)},{default:c(()=>[C(x(n.text),1)]),_:2},1032,["variant","onClick"])]),_:2},1024))),128))]),_:1})}var Et=T(Ct,[["render",Tt]]);const It={props:["line"],computed:{imageSrc(){let e="";return this.line.tag==="IMAGE"&&(e=`${R}/images/avg/imgs/${this.line.params.image}.png`),this.line.tag==="BACKGROUND"&&(e=`${R}/images/avg/bg/${this.line.params.image}.png`),this.line.params.image||(e=e=`${R}/images/avg/bg/bg_black.png`),e}}};function xt(e,t,r,o,s,a){return l(),h(ae,{src:a.imageSrc,class:"my-3"},null,8,["src"])}var Rt=T(It,[["render",xt]]);const kt={props:["line"]};function bt(e,t,r,o,s,a){return l(),h(U,{class:"my-3"},{default:c(()=>[m(ie,{class:"text-center",style:{"font-size":"1rem","line-height":"1.5rem"}},{default:c(()=>[(l(!0),_(f,null,k(r.line.params.text,(n,u)=>(l(),_("p",{key:u},x(n),1))),128))]),_:1})]),_:1})}var Lt=T(kt,[["render",bt]]);const Dt={props:["line","decision"],emits:["selectDecision"],methods:{selectDecision(e){this.$emit("selectDecision",e)}},components:{TagDescription:ft,TagCharacterSpeech:vt,TagDecision:Et,TagImage:Rt,TagSubtitle:Lt}};function Ot(e,t,r,o,s,a){const n=I("TagDescription"),u=I("TagSubtitle"),i=I("TagCharacterSpeech"),d=I("TagDecision"),y=I("TagImage");return r.line.tag==="DESCRIPTION"?(l(),h(n,{key:0,line:r.line},null,8,["line"])):r.line.tag==="SUBTITLE"?(l(),h(u,{key:1,line:r.line},null,8,["line"])):r.line.tag==="CHARACTER_SPEECH"?(l(),h(i,{key:2,line:r.line},null,8,["line"])):r.line.tag==="DECISION"?(l(),h(d,{key:3,line:r.line,decision:r.decision,onSelectDecision:a.selectDecision},null,8,["line","decision","onSelectDecision"])):["IMAGE","BACKGROUND"].includes(r.line.tag)?(l(),h(y,{key:4,line:r.line},null,8,["line"])):v("",!0)}var At=T(Dt,[["render",Ot]]);const Bt={props:["renderBlock"],emits:["selectCharImage"],data(){return{decision:{}}},methods:{selectDecision({id:e,value:t}){this.decision[e]=t},selectCharImage(e){this.$emit("selectCharImage",e)}},computed:{items(){let e=[],t=1,r;for(let o=0;o<this.renderBlock.length;o++){let s=this.renderBlock[o];switch(s.tag){case"DECISION":{r=this.decision[t]||s.params.options[0].value,s.params.id=t,e.push(s),t+=1;break}case"PREDICATE":{let a=s.params.references;if(r){if(!a.includes(r)){for(let n=o+1;n<this.renderBlock.length;n++)if(this.renderBlock[n].tag==="PREDICATE"){o=n-1;break}else if(n===this.renderBlock.length-1){o=n;break}}}else r=null;break}default:{e.push(s);break}}}return e}},components:{StoryReaderRenderItem:At}};function wt(e,t,r,o,s,a){const n=I("StoryReaderRenderItem");return l(!0),_(f,null,k(a.items,(u,i)=>(l(),h(n,{key:i,line:u,decision:s.decision,onSelectDecision:a.selectDecision,onSelectCharImage:a.selectCharImage},null,8,["line","decision","onSelectDecision","onSelectCharImage"]))),128)}var Yt=T(Bt,[["render",wt]]);const $t={props:["value","src"],computed:{show:{get(){return this.value},set(e){this.$emit("set",e)}}}};function Pt(e,t,r,o,s,a){return l(),h(ne,{modelValue:a.show,"onUpdate:modelValue":t[0]||(t[0]=n=>a.show=n),width:"100%",height:"100%",class:"custom-overlay",onClick:t[1]||(t[1]=n=>a.show=!1)},{default:c(()=>[m(ae,{src:r.src},null,8,["src"])]),_:1},8,["modelValue"])}var Nt=T($t,[["render",Pt]]),Vt={format:"image/png",quality:.92,width:void 0,height:void 0,Canvas:void 0,crossOrigin:void 0},Ht=function(e,t){return e===void 0&&(e=[]),t===void 0&&(t={}),new Promise(function(r){t=Object.assign({},Vt,t);var o=t.Canvas?new t.Canvas:window.document.createElement("canvas"),s=t.Image||window.Image,a=e.map(function(u){return new Promise(function(i,d){u.constructor.name!=="Object"&&(u={src:u});var y=new s;y.crossOrigin=t.crossOrigin,y.onerror=function(){return d(new Error("Couldn't load image"))},y.onload=function(){return i(Object.assign({},u,{img:y}))},y.src=u.src})}),n=o.getContext("2d");r(Promise.all(a).then(function(u){var i=function(d){return t[d]||Math.max.apply(Math,u.map(function(y){return y.img[d]}))};return o.width=i("width"),o.height=i("height"),u.forEach(function(d){return n.globalAlpha=d.opacity?d.opacity:1,n.drawImage(d.img,d.x||0,d.y||0)}),t.Canvas&&t.format==="image/jpeg"?new Promise(function(d,y){o.toDataURL(t.format,{quality:t.quality,progressive:!1},function(p,g){if(p){y(p);return}d(g)})}):o.toDataURL(t.format,t.quality)}))})};const Mt={props:["storyData"],inject:["charactersSprites"],data(){return{isReady:!1,renderBlocks:[],imagesUrl:{},charImageSrc:"",charImageDialog:!1}},created(){this.$watch(()=>this.storyData,()=>{this.prepareRenderBlocks()},{immediate:!0})},methods:{getCharNameAndNumFromSpriteName(e){let t="1",r="1",o="";return e.split("#").length>1?([o,t]=e.split("#"),[t,r]=t.split("$")):o=e.split("#")[0],{name:o,num:t,group:r||"1"}},async prepareRenderBlocks(){var n;this.isReady=!1;let e=[],t=[],r,o,s,a={IMAGE:{},BACKGROUND:{},CHARACTER:{}};for(let u=0;u<this.storyData.lines.length;u++){let i=this.storyData.lines[u];switch(i.tag){case"DESCRIPTION":{r?r.tag==="DESCRIPTION"?r.params.text.push(i.params.text):(t.push(r),r={tag:"DESCRIPTION",params:{text:[i.params.text]}}):r={tag:"DESCRIPTION",params:{text:[i.params.text]}};break}case"SUBTITLE":{i.params.text&&(r?r.tag==="SUBTITLE"?r.params.text.push(i.params.text):(t.push(r),r={tag:"SUBTITLE",params:{text:[i.params.text]}}):r={tag:"SUBTITLE",params:{text:[i.params.text]}});break}case"CHARACTER_SPEECH":{let d=b(E({},i.params),{text:[i.params.text],image:s});r?r.tag==="CHARACTER_SPEECH"&&((n=r.params)==null?void 0:n.name.localeCompare(i.params.name,void 0,{sensitivity:"base"}))===0?r.params.text.push(i.params.text):(t.push(r),r={tag:"CHARACTER_SPEECH",params:d}):r={tag:"CHARACTER_SPEECH",params:d};break}case"MULTILINE":{let d={tag:"CHARACTER_SPEECH",params:b(E({},i.params),{text:[i.params.other],image:s})};r&&t.push(r),r=d;break}case"DECISION":{r&&t.push(r);let d=i.params.options.split(";"),y=i.params.values.split(";"),p=!1;if(o){for(let g of y)if(o.options.includes(g)){p=!0;break}}p&&(e.push(t),t=[],r=null),(!o||p)&&(o={options:y}),r=b(E({},i),{params:{options:d.map((g,S)=>({text:g,value:y[S]}))}});break}case"PREDICATE":{r&&t.push(r);let d=i.params.references.split(";");r=b(E({},i),{params:{references:d}});break}case"IMAGE":{r&&t.push(r),r=i;break}case"BACKGROUND":{r&&t.push(r),r=i;break}case"CHARACTER":{if(i.params.focus)switch(parseInt(i.params.focus)){case 1:{s=i.params.name;break}case 2:{s=i.params.name2;break}default:{s=void 0;break}}else s=i.params.name;break}}if(["IMAGE","BACKGROUND","CHARACTER"].includes(i.tag)){if(["IMAGE","BACKGROUND"].includes(i.tag)&&i.params.image&&!(i.params.image in a[i.tag])){let d=new Image,y;i.tag==="IMAGE"&&(y=`${R}/images/avg/imgs/${i.params.image}.png`),i.tag==="BACKGROUND"&&(y=`${R}/images/avg/bg/${i.params.image}.png`),d.src=y,a[i.tag][i.params.image]=y}if(i.tag==="CHARACTER"&&!(s in a.CHARACTER)&&s){let d,y,{name:p,num:g,group:S}=this.getCharNameAndNumFromSpriteName(s);p=p.toLocaleLowerCase(),g=g.trim(),S=S.trim();let D=this.charactersSprites[p];if(D[S].sprites[g].isWholeBody===0){let j=Object.keys(D[S].sprites)[Object.keys(D[S].sprites).length-1];if(j!==g){let oe=D[S].sprites[j].sprite,ce=`${R}/images/avg/characters/${p}/${oe}`,ue=D[S].sprites[g].sprite,de=`${R}/images/avg/characters/${p}/${ue}`;d=await Ht([{src:ce,x:0,y:0},{src:de,x:D[S].facePos.x,y:D[S].facePos.y}],{crossOrigin:"Anonymous"})}}else y=D[S].sprites[g].sprite,d=`${R}/images/avg/characters/${p}/${y}`;a.CHARACTER[s]=d}}}t[t.length-1]!==r&&t.push(r),e[e.length-1]!==t&&e.push(t),this.renderBlocks=e,this.imagesUrl=a,this.isReady=!0},selectCharImage(e){e&&(this.charImageSrc=this.imagesUrl.CHARACTER[e],this.charImageDialog=!0)}},components:{RenderBlock:Yt,CharImageDialog:Nt}};function Ut(e,t,r,o,s,a){const n=I("RenderBlock"),u=I("CharImageDialog");return l(),_(f,null,[s.isReady?v("",!0):(l(),h(F,{key:0,indeterminate:""})),m(se,null,{default:c(()=>[(l(!0),_(f,null,k(s.renderBlocks,(i,d)=>(l(),h(n,{key:d,renderBlock:i,onSelectCharImage:a.selectCharImage},null,8,["renderBlock","onSelectCharImage"]))),128))]),_:1}),m(u,{modelValue:s.charImageDialog,"onUpdate:modelValue":t[0]||(t[0]=i=>s.charImageDialog=i),src:s.charImageSrc,onSet:t[1]||(t[1]=i=>s.charImageDialog=!1)},null,8,["modelValue","src"])],64)}var Ft=T(Mt,[["render",Ut]]);const jt={props:["storyFile"],data(){return{loading:!0,storyData:{lines:[],tagCount:{}},storyInfo:void 0}},created(){this.$watch(()=>[this.storyFile],()=>{this.getStoryInfo()},{immediate:!0})},methods:{getStoryInfo(){this.storyFile.file&&(this.loading=!0,fetch(`${R}/story/${this.storyFile.server}/${this.storyFile.file}.txt`).then(e=>e.text().then(t=>{let r=gt(t);this.storyData=r,this.loading=!1})))}},components:{StoryReaderRender:Ft}};function Gt(e,t,r,o,s,a){const n=I("StoryReaderRender");return l(),_(f,null,[s.loading?(l(),h(F,{key:0,indeterminate:""})):v("",!0),s.loading?v("",!0):(l(),h(n,{key:1,storyData:s.storyData},null,8,["storyData"]))],64)}var zt=T(jt,[["render",Gt]]);const qt={props:["storyType","storyId","storyIndex","server"],async created(){this.loading=!0,await this.getStoryTable(),await this.getCharacterSpritesTable(),this.loading=!1},data(){return{loading:!0,storyTable:{},charactersSprites:{},storyFile:{file:"",server:""}}},provide(){return{charactersSprites:A(()=>this.charactersSprites)}},methods:{async getStoryTable(){await fetch(`${R}/table/story_review_table.json`).then(e=>e.json()).then(e=>{this.storyTable=e})},async getCharacterSpritesTable(){await fetch(`${R}/table/characters_sprites_table.json`).then(e=>e.json()).then(e=>{this.charactersSprites=e})},selectFile({file:e,server:t}){this.storyFile={file:e,server:t}}},components:{StorySelector:ht,StoryReaderMain:zt}};function Kt(e,t,r,o,s,a){const n=I("StorySelector"),u=I("StoryReaderMain");return l(),_(f,null,[s.loading?(l(),h(F,{key:0,indeterminate:""})):v("",!0),s.loading?v("",!0):(l(),_(f,{key:1},[m(n,{storyTable:s.storyTable,onSelectFile:a.selectFile},null,8,["storyTable","onSelectFile"]),m(u,{storyFile:s.storyFile},null,8,["storyFile"])],64))],64)}var Wt=T(qt,[["render",Kt]]);export{Wt as default};
