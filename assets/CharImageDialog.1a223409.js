import{ae as P,r as D,d as _,_ as $,c as f,w as p,o as u,a as I,a3 as h,a4 as k,a5 as w,U as b,e as A,ag as B,b as U,l as V,ah as v,ai as G,t as C,D as S,ad as M,ab as T,h as q}from"./index.f80d835a.js";import{a as E,c as N}from"./VCard.1b618f75.js";import{V as j,a as O}from"./VRow.16b45908.js";import{V as z}from"./VBtn.561a7efe.js";import{t as L}from"./router.d4300e84.js";import{g as F}from"./story-service.447f9484.js";import{H}from"./StoryReaderStore.23d00afa.js";import{V as K}from"./VDialog.20bd5a67.js";const W=P("CharacterSpriteTable",()=>{const e=D();return{characterSpriteTable:e,getCharacterSpriteTable:async()=>{e.value||(e.value=await H.get("/table/characters_sprites_table.json").then(l=>l.data))}}}),J=_({name:"TagDescription",props:{line:Object}});function Q(e,a,l,i,o,s){return u(),f(E,{class:"my-3"},{default:p(()=>[I(N,{style:{"font-size":"1rem","line-height":"1.5rem"}},{default:p(()=>{var t;return[(u(!0),h(b,null,k((t=e.line)==null?void 0:t.params.text,(n,c)=>(u(),h("p",{key:c},w(n),1))),128))]}),_:1})]),_:1})}const X=$(J,[["render",Q]]),Y=_({name:"TagSubtitle",props:{line:Object}});function Z(e,a,l,i,o,s){return u(),f(E,{class:"my-3"},{default:p(()=>[I(N,{class:"text-center",style:{"font-size":"1rem","line-height":"1.5rem"}},{default:p(()=>{var t;return[(u(!0),h(b,null,k((t=e.line)==null?void 0:t.params.text,(n,c)=>(u(),h("p",{key:c},w(n),1))),128))]}),_:1})]),_:1})}const ee=$(Y,[["render",Z]]),ae=_({name:"TagCharacterSpeech",props:{line:Object},emits:["selectCharImage"]});function te(e,a,l,i,o,s){return u(),f(j,{class:"my-3"},{default:p(()=>[I(O,{cols:"12",sm:"2",class:"pb-0 pb-sm-3"},{default:p(()=>{var t,n;return[A("p",{class:B(["font-weight-bold text-grey",[{hasImage:(t=e.line)==null?void 0:t.params.image}]]),onClick:a[0]||(a[0]=c=>{var r;return e.$emit("selectCharImage",(r=e.line)==null?void 0:r.params.image)})},w((n=e.line)==null?void 0:n.params.name),3)]}),_:1}),I(O,{cols:"12",sm:"8",class:"pt-0 pt-sm-3"},{default:p(()=>{var t;return[(u(!0),h(b,null,k((t=e.line)==null?void 0:t.params.text,(n,c)=>(u(),h("p",{key:c,class:B({"mt-1":c>0})},w(n),3))),128))]}),_:1})]),_:1})}const ne=$(ae,[["render",te],["__scopeId","data-v-e10541f6"]]),re=_({name:"TagDecision",props:{line:Object,decision:Number},emits:["selectDecision"],setup(e){return{getVariant:l=>{var s;let i="elevated";return(e.decision||parseInt((s=e.line)==null?void 0:s.params.options[0].value))===parseInt(l)&&(i="outlined"),i}}}});function se(e,a,l,i,o,s){return u(),f(j,{dense:"",class:"my-3"},{default:p(()=>{var t;return[(u(!0),h(b,null,k((t=e.line)==null?void 0:t.params.options,(n,c)=>(u(),f(O,{cols:"12",key:c},{default:p(()=>[I(z,{class:"float-right text-right decision-option",variant:e.getVariant(n.value),onClick:r=>e.$emit("selectDecision",n.value)},{default:p(()=>[U(w(n.text),1)]),_:2},1032,["variant","onClick"])]),_:2},1024))),128))]}),_:1})}const ie=$(re,[["render",se]]),ce=_({name:"TagImage",props:{line:Object},setup(e){return{imageSrc:V(()=>{var i,o,s,t,n;let l="";return(i=e.line)!=null&&i.params.image?(((o=e.line)==null?void 0:o.tag)==="IMAGE"&&(l=`${v}/images/avg/imgs/${(s=e.line)==null?void 0:s.params.image}.webp`),((t=e.line)==null?void 0:t.tag)==="BACKGROUND"&&(l=`${v}/images/avg/bg/${(n=e.line)==null?void 0:n.params.image}.webp`)):l=`${v}/images/avg/bg/bg_black.webp`,l})}}});function le(e,a,l,i,o,s){return u(),f(L,{src:e.imageSrc,class:"my-3"},null,8,["src"])}const oe=$(ce,[["render",le]]),me=_({name:"RenderBlock",emits:["selectCharImage"],props:{renderBlock:{type:[Object],default:[]}},setup(e){const a=G({}),l=({id:o,value:s})=>{a[o]=parseInt(s)},i=V(()=>{let o=[],s;for(let t=0;t<e.renderBlock.length;t++){let n=e.renderBlock[t];switch(n.tag){case"DECISION":{s=a[t]||parseInt(n.params.options[0].value),o.push(t);break}case"PREDICATE":{let c=n.params.references;if(s){if(!c.includes(s.toString())){for(let r=t+1;r<e.renderBlock.length;r++)if(e.renderBlock[r].tag==="PREDICATE"){t=r-1;break}else if(r===e.renderBlock.length-1){t=r;break}}}else s=null;break}default:{o.push(t);break}}}return o});return{decisionByLineIndex:a,selectDecision:l,lineIndexsToShow:i}},components:{TagDescription:X,TagSubtitle:ee,TagCharacterSpeech:ne,TagDecision:ie,TagImage:oe}});function ue(e,a,l,i,o,s){const t=T("TagDescription"),n=T("TagSubtitle"),c=T("TagCharacterSpeech"),r=T("TagDecision"),m=T("TagImage");return u(!0),h(b,null,k(e.renderBlock,(g,d)=>(u(),h(b,{key:d},[g.tag==="DESCRIPTION"?C((u(),f(t,{key:0,line:g},null,8,["line"])),[[S,e.lineIndexsToShow.includes(d)]]):g.tag==="SUBTITLE"?C((u(),f(n,{key:1,line:g},null,8,["line"])),[[S,e.lineIndexsToShow.includes(d)]]):g.tag==="DIALOG"?C((u(),f(c,{key:2,line:g,onSelectCharImage:a[0]||(a[0]=y=>{e.$emit("selectCharImage",y)})},null,8,["line"])),[[S,e.lineIndexsToShow.includes(d)]]):g.tag==="DECISION"?C((u(),f(r,{key:3,line:g,decision:e.decisionByLineIndex[d],onSelectDecision:y=>{e.selectDecision({id:d,value:y})}},null,8,["line","decision","onSelectDecision"])),[[S,e.lineIndexsToShow.includes(d)]]):["IMAGE","BACKGROUND"].includes(g.tag)?C((u(),f(m,{key:4,line:g},null,8,["line"])),[[S,e.lineIndexsToShow.includes(d)]]):M("",!0)],64))),128)}const Se=$(me,[["render",ue]]);var ge={format:"image/png",quality:.92,width:void 0,height:void 0,Canvas:void 0,crossOrigin:void 0},de=function(e,a){return e===void 0&&(e=[]),a===void 0&&(a={}),new Promise(function(l){a=Object.assign({},ge,a);var i=a.Canvas?new a.Canvas:window.document.createElement("canvas"),o=a.Image||window.Image,s=e.map(function(n){return new Promise(function(c,r){n.constructor.name!=="Object"&&(n={src:n});var m=new o;m.crossOrigin=a.crossOrigin,m.onerror=function(){return r(new Error("Couldn't load image"))},m.onload=function(){return c(Object.assign({},n,{img:m}))},m.src=n.src})}),t=i.getContext("2d");l(Promise.all(s).then(function(n){var c=function(r){return a[r]||Math.max.apply(Math,n.map(function(m){return m.img[r]}))};return i.width=c("width"),i.height=c("height"),n.forEach(function(r){return t.globalAlpha=r.opacity?r.opacity:1,t.drawImage(r.img,r.x||0,r.y||0)}),a.Canvas&&a.format==="image/jpeg"?new Promise(function(r,m){i.toDataURL(a.format,{quality:a.quality,progressive:!1},function(g,d){if(g){m(g);return}r(d)})}):i.toDataURL(a.format,a.quality)}))})};const fe=_({name:"CharImageDialog",emits:["closeDialog"],props:{charImage:String},setup(e){const{characterSpriteTable:a}=W(),l=D({}),i=D(!1),o=D("");return q(()=>e.charImage,async()=>{if(e.charImage){if(l.value[e.charImage])i.value=!0,o.value=l.value[e.charImage];else if(a){let s="",t,{name:n,num:c,group:r}=F(e.charImage);n=n.toLowerCase(),c=c.trim(),r=r.trim();let m=a[n];if(m[r].sprites[c].isWholeBody===0){let g=Object.keys(m[r].sprites)[Object.keys(m[r].sprites).length-1];if(g!==c){let d=m[r].sprites[g].sprite,y=`${v}/images/avg/characters/${n}/${d}`,R=m[r].sprites[c].sprite,x=`${v}/images/avg/characters/${n}/${R}`;s=await de([{src:y,x:0,y:0},{src:x,x:m[r].facePos.x,y:m[r].facePos.y}],{crossOrigin:"anonymous",format:"image/webp"})}}else t=m[r].sprites[c].sprite,s=`${v}/images/avg/characters/${n}/${t}`;l.value[e.charImage]=s,o.value=s,i.value=!0}}else i.value=!1}),{show:i,imageSrc:o}}});function pe(e,a,l,i,o,s){return u(),f(K,{modelValue:e.show,"onUpdate:modelValue":a[0]||(a[0]=t=>e.show=t),class:"custom-overlay",onClick:a[1]||(a[1]=t=>e.$emit("closeDialog"))},{default:p(()=>[I(L,{src:e.imageSrc},null,8,["src"])]),_:1},8,["modelValue"])}const Te=$(fe,[["render",pe]]);export{Te as C,Se as R,W as u};
